name: Deploy LMS to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages  # Use the github-pages environment you created earlier
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate config file from environment variables
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LINKEDIN_CLIENT_ID: ${{ secrets.LINKEDIN_CLIENT_ID }}
          LINKEDIN_CLIENT_SECRET: ${{ secrets.LINKEDIN_CLIENT_SECRET }}
          LINKEDIN_REDIRECT_URI: ${{ secrets.LINKEDIN_REDIRECT_URI }}
          LINKEDIN_ENCRYPTION_KEY: ${{ secrets.LINKEDIN_ENCRYPTION_KEY }}
        run: |
          # Ensure config directory exists
          mkdir -p config
          
          # Check for required secrets
          echo "ðŸ” Checking required secrets..."
          MISSING_SECRETS=()
          [ -z "$SUPABASE_URL" ] && MISSING_SECRETS+=("SUPABASE_URL")
          [ -z "$SUPABASE_ANON_KEY" ] && MISSING_SECRETS+=("SUPABASE_ANON_KEY")
          [ -z "$SUPABASE_SERVICE_KEY" ] && MISSING_SECRETS+=("SUPABASE_SERVICE_KEY")
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets: ${MISSING_SECRETS[*]}"
            echo "Please configure these secrets in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          # Check optional secrets and warn
          OPTIONAL_MISSING=()
          [ -z "$OPENAI_API_KEY" ] && OPTIONAL_MISSING+=("OPENAI_API_KEY")
          [ -z "$LINKEDIN_CLIENT_ID" ] && OPTIONAL_MISSING+=("LINKEDIN_CLIENT_ID")
          [ -z "$LINKEDIN_CLIENT_SECRET" ] && OPTIONAL_MISSING+=("LINKEDIN_CLIENT_SECRET")
          [ -z "$LINKEDIN_REDIRECT_URI" ] && OPTIONAL_MISSING+=("LINKEDIN_REDIRECT_URI")
          [ -z "$LINKEDIN_ENCRYPTION_KEY" ] && OPTIONAL_MISSING+=("LINKEDIN_ENCRYPTION_KEY")
          
          if [ ${#OPTIONAL_MISSING[@]} -gt 0 ]; then
            echo "âš ï¸ Warning: Optional secrets not set: ${OPTIONAL_MISSING[*]}"
            echo "Some features may not work without these."
          fi
          
          # Function to escape single quotes for JavaScript strings
          escape_js() {
            echo "$1" | sed "s/'/\\\\'/g"
          }
          
          # Generate config file
          {
            echo "/**"
            echo " * LMS Backend Configuration"
            echo " *"
            echo " * This file is auto-generated by GitHub Actions from environment variables."
            echo " * Do not edit manually - it will be overwritten on each deployment."
            echo " */"
            echo ""
            echo "window.LMS_CONFIG = {"
            echo "    SUPABASE_URL: '$(escape_js "$SUPABASE_URL")',"
            echo "    SUPABASE_ANON_KEY: '$(escape_js "$SUPABASE_ANON_KEY")',"
            echo "    SUPABASE_SERVICE_KEY: '$(escape_js "$SUPABASE_SERVICE_KEY")',"
            echo "    ADMIN_USERNAME: '$(escape_js "$ADMIN_USERNAME")',"
            echo "    ADMIN_PASSWORD: '$(escape_js "$ADMIN_PASSWORD")',"
            echo "    ADMIN_EMAIL: '$(escape_js "$ADMIN_EMAIL")',"
            echo "    OPENAI_API_KEY: '$(escape_js "$OPENAI_API_KEY")',"
            echo "    LINKEDIN_CLIENT_ID: '$(escape_js "$LINKEDIN_CLIENT_ID")',"
            echo "    LINKEDIN_CLIENT_SECRET: '$(escape_js "$LINKEDIN_CLIENT_SECRET")',"
            echo "    LINKEDIN_REDIRECT_URI: '$(escape_js "$LINKEDIN_REDIRECT_URI")',"
            echo "    LINKEDIN_ENCRYPTION_KEY: '$(escape_js "$LINKEDIN_ENCRYPTION_KEY")'"
            echo "};"
          } > config/app.config.local.js
          
          # Verify file was created and has content
          if [ -f "config/app.config.local.js" ]; then
            FILE_SIZE=$(wc -c < config/app.config.local.js)
            if [ "$FILE_SIZE" -gt 200 ]; then
              echo "âœ… Config file created successfully ($FILE_SIZE bytes)"
              # Show structure without values (for verification)
              echo "ðŸ“„ Config file structure (values redacted):"
              grep -E "^\s+[A-Z_]+:" config/app.config.local.js | sed 's/:.*/: [REDACTED]/' || true
            else
              echo "âš ï¸ Warning: Config file is very small ($FILE_SIZE bytes) - may be missing values"
              echo "File contents (first 500 chars):"
              head -c 500 config/app.config.local.js
              exit 1
            fi
          else
            echo "âŒ Error: Config file was not created!"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

