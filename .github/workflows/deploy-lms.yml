name: Deploy LMS to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages  # Use the github-pages environment you created earlier
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate config file from environment variables
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > config/app.config.local.js << EOF
          /**
           * LMS Backend Configuration
           * 
           * This file is auto-generated by GitHub Actions from environment variables.
           * Do not edit manually - it will be overwritten on each deployment.
           */
          
          window.LMS_CONFIG = {
              SUPABASE_URL: '${SUPABASE_URL}',
              SUPABASE_ANON_KEY: '${SUPABASE_ANON_KEY}',
              SUPABASE_SERVICE_KEY: '${SUPABASE_SERVICE_KEY}',
              ADMIN_USERNAME: '${ADMIN_USERNAME}',
              ADMIN_PASSWORD: '${ADMIN_PASSWORD}',
              ADMIN_EMAIL: '${ADMIN_EMAIL}',
              OPENAI_API_KEY: '${OPENAI_API_KEY}'
          };
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

