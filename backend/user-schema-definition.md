# User Schema Definition

## Overview

The User data model is implemented using Supabase's authentication system combined with a profile table. This follows security best practices by separating authentication data from application data.

## Schema Structure

### auth.users (Supabase Managed)
- **id** (UUID, Primary Key) - Auto-generated by Supabase
- **email** (TEXT, Unique) - User's email address
- **encrypted_password** (TEXT) - Password hash (managed by Supabase)
- **created_at** (TIMESTAMPTZ) - Account creation timestamp
- **updated_at** (TIMESTAMPTZ) - Last update timestamp

**Note:** The `auth.users` table is managed by Supabase and handles password hashing automatically. We never directly access or modify password data.

### public.users (Application Profile)
- **id** (UUID, Primary Key) - References `auth.users(id)`
- **email** (TEXT, Unique, NOT NULL) - User's email (synced from auth)
- **name** (TEXT, NOT NULL) - User's full name
- **full_name** (TEXT) - Legacy field (kept for compatibility)
- **role** (TEXT, NOT NULL, DEFAULT 'learner') - User role: `'learner'` or `'trainer'`
- **status** (TEXT, NOT NULL, DEFAULT 'pending') - Approval status: `'pending'`, `'approved'`, or `'rejected'`
- **is_admin** (BOOLEAN, DEFAULT FALSE) - Admin flag
- **approved_at** (TIMESTAMPTZ) - When user was approved (if approved)
- **approved_by** (UUID) - ID of admin who approved (if approved)
- **created_at** (TIMESTAMPTZ, DEFAULT NOW()) - Profile creation timestamp
- **updated_at** (TIMESTAMPTZ, DEFAULT NOW()) - Last update timestamp

## Field Details

### id
- **Type:** UUID
- **Auto-generated:** Yes (by Supabase Auth)
- **Unique:** Yes
- **References:** `auth.users(id)`
- **Notes:** Primary key, automatically created when user signs up

### name
- **Type:** TEXT
- **Required:** Yes (NOT NULL)
- **Default:** None
- **Notes:** User's full name, displayed in the application

### email
- **Type:** TEXT
- **Required:** Yes (NOT NULL, UNIQUE)
- **Validation:** Must be valid email format
- **Case-insensitive:** Yes (stored in lowercase)
- **Notes:** Used for login and must be unique across all users

### passwordHash
- **Type:** TEXT (encrypted)
- **Storage:** In `auth.users.encrypted_password` (NOT in `public.users`)
- **Hashing:** Handled automatically by Supabase Auth
- **Access:** Never directly accessed by application code
- **Security:** Uses bcrypt with secure salt generation

### role
- **Type:** TEXT
- **Required:** Yes (NOT NULL)
- **Default:** `'learner'`
- **Allowed Values:** `'learner'`, `'trainer'`
- **Validation:** CHECK constraint enforces valid values
- **Notes:** Determines user permissions and access level

### status
- **Type:** TEXT
- **Required:** Yes (NOT NULL)
- **Default:** `'pending'`
- **Allowed Values:** `'pending'`, `'approved'`, `'rejected'`
- **Validation:** CHECK constraint enforces valid values
- **Notes:** 
  - New users start with `'pending'`
  - Admins can change to `'approved'` or `'rejected'`
  - Only approved users can access the full application

### createdAt
- **Type:** TIMESTAMPTZ
- **Auto-generated:** Yes (DEFAULT NOW())
- **Notes:** Timestamp when user profile was created

## Constraints

### Unique Constraints
- **email:** Must be unique across all users
- **id:** Primary key, unique by definition

### Check Constraints
- **role:** Must be `'learner'` or `'trainer'`
- **status:** Must be `'pending'`, `'approved'`, or `'rejected'`

### Foreign Key Constraints
- **id:** References `auth.users(id)` (CASCADE on delete)
- **approved_by:** References `auth.users(id)` (nullable)

## Indexes

For performance optimization:
- **idx_users_email:** Index on `email` for fast lookups
- **idx_users_status:** Index on `status` for filtering
- **idx_users_role:** Index on `role` for filtering
- **idx_users_is_admin:** Index on `is_admin` for admin queries

## Security

### Row-Level Security (RLS)
All tables have RLS enabled with policies:
- Users can read/update their own profile
- Admins can read/update all profiles
- Users cannot modify `is_admin` or `approved_at` directly

### Password Security
- Passwords are **never** stored in plain text
- Password hashing is handled by Supabase Auth (bcrypt)
- Passwords are **never** stored in `public.users` table
- Application code never has access to password hashes

## Data Flow

### User Registration
1. User provides: name, email, password
2. `createUser()` calls Supabase Auth `signUp()`
3. Supabase creates entry in `auth.users` (hashes password)
4. Trigger `handle_new_user()` creates profile in `public.users`
5. Profile created with: name, email, role, status='pending'

### User Lookup
1. `getUserByEmail()` queries `public.users` by email
2. Returns user profile with all fields
3. Password is never included (not in this table)

### Status Update
1. `updateUserStatus()` updates `public.users.status`
2. Sets `approved_at` and `approved_by` if approved
3. Clears approval fields if rejected or pending

## Migration Notes

If you have existing users:
- Run `user-schema-update.sql` to add new fields
- Existing users will get default values:
  - `name`: From `full_name` or empty string
  - `role`: `'learner'`
  - `status`: `'approved'` if `approved_at` exists, else `'pending'`

## Example User Object

```javascript
{
    id: "550e8400-e29b-41d4-a716-446655440000",
    email: "user@example.com",
    name: "John Doe",
    role: "learner",
    status: "pending",
    createdAt: "2025-01-27T10:00:00Z",
    updatedAt: "2025-01-27T10:00:00Z"
}
```

